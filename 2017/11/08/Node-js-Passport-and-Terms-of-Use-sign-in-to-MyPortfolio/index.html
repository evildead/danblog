<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Node.js Passport and Terms of Use: sign in to MyPortfolio | Dan Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="In my application named MyPortfolio (built with Node.js/Express and MongoDB), I decided to use Passport as authentication middleware. It is extremely flexible and modular, and it comes with a comprehe">
<meta property="og:type" content="article">
<meta property="og:title" content="Node.js Passport and Terms of Use: sign in to MyPortfolio">
<meta property="og:url" content="http://yoursite.com/2017/11/08/Node-js-Passport-and-Terms-of-Use-sign-in-to-MyPortfolio/index.html">
<meta property="og:site_name" content="Dan Blog">
<meta property="og:description" content="In my application named MyPortfolio (built with Node.js/Express and MongoDB), I decided to use Passport as authentication middleware. It is extremely flexible and modular, and it comes with a comprehe">
<meta property="og:locale" content="En">
<meta property="og:updated_time" content="2017-11-13T17:15:42.197Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Node.js Passport and Terms of Use: sign in to MyPortfolio">
<meta name="twitter:description" content="In my application named MyPortfolio (built with Node.js/Express and MongoDB), I decided to use Passport as authentication middleware. It is extremely flexible and modular, and it comes with a comprehe">
  
    <link rel="alternate" href="/atom.xml" title="Dan Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Dan Blog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">Welcome to Danilo Carrabino&#39;s Blog</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Node-js-Passport-and-Terms-of-Use-sign-in-to-MyPortfolio" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/11/08/Node-js-Passport-and-Terms-of-Use-sign-in-to-MyPortfolio/" class="article-date">
  <time datetime="2017-11-08T16:49:20.000Z" itemprop="datePublished">2017-11-08</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Node.js Passport and Terms of Use: sign in to MyPortfolio
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>In my application named <a href="http://myportfolio.danilocarrabino.net" target="_blank" rel="external">MyPortfolio</a> (built with Node.js/Express and MongoDB), I decided to use <a href="http://www.passportjs.org/" target="_blank" rel="external">Passport</a> as authentication middleware.</p>
<p>It is extremely flexible and modular, and it comes with a comprehensive set of strategies which support authentication using a <em>username and password</em>, <em>Google-OAuth</em>, <em>Facebook</em>, <em>Twitter</em>, and more.</p>
<p>I started developing a Passport authentication, by following a very interesting tutorial of <a href="https://scotch.io/tutorials/easy-node-authentication-setup-and-local" target="_blank" rel="external">Scotch.io</a>, where it is clearly illustrated how to use <em>Passport</em> to perform local authentication, <em>Facebook</em>, <em>Twitter</em>, <em>Google</em> authentications, and even how to link all social accounts under one user account.</p>
<p>But there was something lacking in that tutorial, and many other <em>Passport</em> tutorials I found on the web: how could I use <em>Passport</em> middleware to perform a sign-up only after user viewed and accepted my application’s Terms of Use?</p>
<p>Let me show you the architecture, the models and the operations flow I used (check also the code here <em><a href="https://github.com/evildead/my-portfolio" target="_blank" rel="external">MyPortfolio code</a></em>).</p>
<h2 id="Package-json"><a href="#Package-json" class="headerlink" title="Package.json"></a>Package.json</h2><p>Here are the dependencies I’m using in <em><a href="https://github.com/evildead/my-portfolio/blob/master/package.json" target="_blank" rel="external">package.json</a></em>:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// package.json</span></div><div class="line"></div><div class="line">...</div><div class="line">  <span class="string">"dependencies"</span>: &#123;</div><div class="line">    <span class="string">"async"</span>: <span class="string">"^2.5.0"</span>,</div><div class="line">    <span class="string">"bcrypt-nodejs"</span>: <span class="string">"0.0.3"</span>,</div><div class="line">    <span class="string">"body-parser"</span>: <span class="string">"^1.18.2"</span>,</div><div class="line">    <span class="string">"connect-flash"</span>: <span class="string">"^0.1.1"</span>,</div><div class="line">    <span class="string">"cookie-parser"</span>: <span class="string">"^1.4.3"</span>,</div><div class="line">    <span class="string">"dotenv"</span>: <span class="string">"^4.0.0"</span>,</div><div class="line">    <span class="string">"ejs"</span>: <span class="string">"^2.5.7"</span>,</div><div class="line">    <span class="string">"express"</span>: <span class="string">"^4.14.0"</span>,</div><div class="line">    <span class="string">"express-ejs-layouts"</span>: <span class="string">"^2.3.1"</span>,</div><div class="line">    <span class="string">"express-session"</span>: <span class="string">"^1.15.6"</span>,</div><div class="line">    <span class="string">"express-validator"</span>: <span class="string">"^4.2.1"</span>,</div><div class="line">    <span class="string">"fs-extra"</span>: <span class="string">"^4.0.2"</span>,</div><div class="line">    <span class="string">"mongoose"</span>: <span class="string">"^4.11.13"</span>,</div><div class="line">    <span class="string">"multer"</span>: <span class="string">"^1.3.0"</span>,</div><div class="line">    <span class="string">"passport"</span>: <span class="string">"^0.4.0"</span>,</div><div class="line">    <span class="string">"passport-facebook"</span>: <span class="string">"^2.1.1"</span>,</div><div class="line">    <span class="string">"passport-google-oauth"</span>: <span class="string">"^1.0.0"</span>,</div><div class="line">    <span class="string">"passport-local"</span>: <span class="string">"^1.0.0"</span>,</div><div class="line">    <span class="string">"passport-twitter"</span>: <span class="string">"^1.0.4"</span>,</div><div class="line">    <span class="string">"summernote-nodejs"</span>: <span class="string">"^1.0.4"</span></div><div class="line">  &#125;</div><div class="line">...</div></pre></td></tr></table></figure></p>
<p>Because of I decided to let users log in only with their Google accounts in MyPortfolio, the dependencies of interest in this post are:</p>
<ul>
<li><em>express</em> is the framework.</li>
<li><em>express-session</em> to handle the session in Express framework.</li>
<li><em>ejs</em> is the templating engine.</li>
<li><em>mongoose</em> is the object modeling for our MongoDB database.</li>
<li><em>passport</em> and <em>passport-google-oauth</em> for Google authentication.</li>
<li><em>connect-flash</em> allows to pass session flashdata messages.</li>
<li><em>async</em> lets easily perform asynchronous operations.</li>
<li><em>fs-extra</em> empowers Node.js fs library with Promises.</li>
</ul>
<h2 id="User-model"><a href="#User-model" class="headerlink" title="User model"></a>User model</h2><p>Here is the <em><a href="https://github.com/evildead/my-portfolio/blob/master/app/models/user.js" target="_blank" rel="external">user model schema</a></em>, which resembles the one in the <em>Scotch.io</em> tutorial.<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// user.js</span></div><div class="line"></div><div class="line">...</div><div class="line"><span class="keyword">var</span> userSchema = mongoose.Schema(&#123;</div><div class="line"></div><div class="line">    local            : &#123;</div><div class="line">        email        : <span class="built_in">String</span>,</div><div class="line">        password     : <span class="built_in">String</span>,</div><div class="line">    &#125;,</div><div class="line">    facebook         : &#123;</div><div class="line">        id           : <span class="built_in">String</span>,</div><div class="line">        token        : <span class="built_in">String</span>,</div><div class="line">        email        : <span class="built_in">String</span>,</div><div class="line">        name         : <span class="built_in">String</span></div><div class="line">    &#125;,</div><div class="line">    twitter          : &#123;</div><div class="line">        id           : <span class="built_in">String</span>,</div><div class="line">        token        : <span class="built_in">String</span>,</div><div class="line">        displayName  : <span class="built_in">String</span>,</div><div class="line">        username     : <span class="built_in">String</span></div><div class="line">    &#125;,</div><div class="line">    google           : &#123;</div><div class="line">        id           : <span class="built_in">String</span>,</div><div class="line">        token        : <span class="built_in">String</span>,</div><div class="line">        email        : &#123;<span class="attr">type</span>: <span class="built_in">String</span>, <span class="attr">index</span>: <span class="literal">true</span>&#125;,</div><div class="line">        name         : &#123;<span class="attr">type</span>: <span class="built_in">String</span>, <span class="attr">index</span>: <span class="literal">true</span>&#125;,</div><div class="line">        imageUrl     : <span class="built_in">String</span>,</div><div class="line">        eslug        : <span class="built_in">String</span></div><div class="line">    &#125;,</div><div class="line">    mustacceptterms  : &#123;</div><div class="line">        type: <span class="built_in">Boolean</span>,</div><div class="line">        <span class="keyword">default</span>: <span class="string">'false'</span></div><div class="line">    &#125;</div><div class="line">&#125;);</div><div class="line">...</div></pre></td></tr></table></figure></p>
<p>You can notice that in the userSchema I added another boolean parameter, named <em>mustacceptterms</em>: this one will be true until the user will have explicitly confirmed to have read and accepted the Terms of Use.</p>
<h2 id="Application-setup"><a href="#Application-setup" class="headerlink" title="Application setup"></a>Application setup</h2><p><em><a href="https://github.com/evildead/my-portfolio/blob/master/server.js" target="_blank" rel="external">server.js</a></em> contains the setup of the different packages, included <em>Express</em>, <em>Passport</em>, <em>Session</em> and <em>Mongoose</em></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// server.js</span></div><div class="line"></div><div class="line"><span class="comment">// load environment variables</span></div><div class="line"><span class="built_in">require</span>(<span class="string">'dotenv'</span>).config();</div><div class="line"></div><div class="line"><span class="comment">// grab our dependencies</span></div><div class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>),</div><div class="line">    app = express(),</div><div class="line">    port = process.env.PORT || <span class="number">8080</span></div><div class="line">    expressLayouts = <span class="built_in">require</span>(<span class="string">'express-ejs-layouts'</span>),</div><div class="line">    mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>),</div><div class="line">    passport = <span class="built_in">require</span>(<span class="string">'passport'</span>),</div><div class="line">    bodyParser = <span class="built_in">require</span>(<span class="string">'body-parser'</span>),</div><div class="line">    session = <span class="built_in">require</span>(<span class="string">'express-session'</span>),</div><div class="line">    cookieParser = <span class="built_in">require</span>(<span class="string">'cookie-parser'</span>),</div><div class="line">    flash = <span class="built_in">require</span>(<span class="string">'connect-flash'</span>),</div><div class="line">    expressValidator = <span class="built_in">require</span>(<span class="string">'express-validator'</span>);</div><div class="line"></div><div class="line"><span class="comment">// configure our application</span></div><div class="line"><span class="comment">// set sessions and cookie parser</span></div><div class="line">app.use(cookieParser());</div><div class="line">app.use(session(&#123;</div><div class="line">    secret: process.env.SECRET,</div><div class="line">    cookie: &#123;<span class="attr">maxAge</span>: <span class="number">8</span>*<span class="number">60</span>*<span class="number">60</span>*<span class="number">1000</span>&#125;, <span class="comment">// 8 hours</span></div><div class="line">    resave: <span class="literal">false</span>,      <span class="comment">// forces the session to be saved back to the store</span></div><div class="line">    saveUninitialized: <span class="literal">false</span>    <span class="comment">// don't save unmodified sessions</span></div><div class="line">&#125;));</div><div class="line">app.use(flash());</div><div class="line"></div><div class="line"><span class="comment">// tell express where to look for static assets</span></div><div class="line">app.use(express.static(__dirname + <span class="string">'/public'</span>));</div><div class="line"></div><div class="line"><span class="comment">// set ejs as templating engine</span></div><div class="line">app.set(<span class="string">'view engine'</span>, <span class="string">'ejs'</span>);</div><div class="line">app.use(expressLayouts);</div><div class="line"></div><div class="line"><span class="comment">// connect to the database</span></div><div class="line">mongoose.connect(process.env.DB_URI);</div><div class="line"></div><div class="line"><span class="comment">// use bodyParser to grab info from a json</span></div><div class="line">app.use(bodyParser.json(&#123;<span class="attr">limit</span>: <span class="string">'50mb'</span>&#125;));</div><div class="line"><span class="comment">// use bodyParser to grab info from a form</span></div><div class="line">app.use(bodyParser.urlencoded(&#123;<span class="attr">limit</span>: <span class="string">'50mb'</span>, <span class="attr">extended</span>: <span class="literal">true</span>&#125;));</div><div class="line"></div><div class="line"><span class="comment">// express validator -&gt; validate form or URL parameters</span></div><div class="line">app.use(expressValidator());</div><div class="line"></div><div class="line">app.use(passport.initialize());</div><div class="line">app.use(passport.session()); <span class="comment">// persistent login sessions</span></div><div class="line"></div><div class="line"><span class="built_in">require</span>(<span class="string">'./config/passport'</span>)(passport); <span class="comment">// pass passport for configuration</span></div><div class="line"></div><div class="line"><span class="comment">// set the routes</span></div><div class="line">app.use(<span class="built_in">require</span>(<span class="string">'./app/routes'</span>));</div><div class="line"></div><div class="line"><span class="comment">// start our server</span></div><div class="line">app.listen(port, () =&gt; &#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">`App listening on http://localhost:<span class="subst">$&#123;port&#125;</span>`</span>);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h2 id="Passport-Configuration"><a href="#Passport-Configuration" class="headerlink" title="Passport Configuration"></a>Passport Configuration</h2><p>The <em>passport</em> object is passed as parameter to <em><a href="https://github.com/evildead/my-portfolio/blob/master/config/passport.js" target="_blank" rel="external">config/passport.js</a></em> where the Google OAuth strategy will be configured:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// config/passport.js</span></div><div class="line"></div><div class="line"><span class="comment">// load only the Google strategy, because the login to My-Portfolio</span></div><div class="line"><span class="comment">// will be only possible by using the Google account</span></div><div class="line"><span class="keyword">var</span> GoogleStrategy = <span class="built_in">require</span>(<span class="string">'passport-google-oauth'</span>).OAuth2Strategy;</div><div class="line"></div><div class="line"><span class="comment">// load up the user model</span></div><div class="line"><span class="keyword">var</span> User = <span class="built_in">require</span>(<span class="string">'../app/models/user'</span>);</div><div class="line"></div><div class="line"><span class="keyword">const</span> initUserFolderStructure = <span class="built_in">require</span>(<span class="string">'../app/utilities'</span>).initUserFolderStructure;</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">passport</span>) </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// =========================================================================</span></div><div class="line">    <span class="comment">// passport session setup ==================================================</span></div><div class="line">    <span class="comment">// =========================================================================</span></div><div class="line">    <span class="comment">// required for persistent login sessions</span></div><div class="line">    <span class="comment">// passport needs ability to serialize and unserialize users out of session</span></div><div class="line"></div><div class="line">    <span class="comment">// used to serialize the user for the session</span></div><div class="line">    passport.serializeUser(<span class="function"><span class="keyword">function</span>(<span class="params">user, done</span>) </span>&#123;</div><div class="line">        done(<span class="literal">null</span>, user.id);</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    <span class="comment">// used to deserialize the user</span></div><div class="line">    passport.deserializeUser(<span class="function"><span class="keyword">function</span>(<span class="params">id, done</span>) </span>&#123;</div><div class="line">        User.findById(id, <span class="function"><span class="keyword">function</span>(<span class="params">err, user</span>) </span>&#123;</div><div class="line">            done(err, user);</div><div class="line">        &#125;);</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    <span class="comment">// =========================================================================</span></div><div class="line">    <span class="comment">// GOOGLE ==================================================================</span></div><div class="line">    <span class="comment">// =========================================================================</span></div><div class="line">    passport.use(<span class="keyword">new</span> GoogleStrategy(&#123;</div><div class="line"></div><div class="line">        clientID          : process.env.GOOGLEAUTH_clientID,</div><div class="line">        clientSecret      : process.env.GOOGLEAUTH_clientSecret,</div><div class="line">        callbackURL       : process.env.GOOGLEAUTH_callbackURL,</div><div class="line">        passReqToCallback : <span class="literal">true</span> <span class="comment">// allows us to pass in the req from our route (lets us check if a user is logged in or not)</span></div><div class="line"></div><div class="line">    &#125;,</div><div class="line">    ...</div></pre></td></tr></table></figure>
<p>As shown above, <em>passport</em> will use only the Google Oauth strategy, and the interesting part regards the callback invoked after authentication succeeds:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line"><span class="function"><span class="keyword">function</span>(<span class="params">req, token, refreshToken, profile, done</span>) </span>&#123;</div><div class="line">    <span class="comment">// check if the user is already logged in</span></div><div class="line">    <span class="keyword">if</span> (!req.user) &#123;</div><div class="line"></div><div class="line">        User.findOne(&#123; <span class="string">'google.id'</span> : profile.id &#125;, <span class="function"><span class="keyword">function</span>(<span class="params">err, user</span>) </span>&#123;</div><div class="line">            <span class="keyword">if</span> (err) &#123;</div><div class="line">                <span class="keyword">return</span> done(err);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (user) &#123;</div><div class="line">                <span class="comment">// if there is a user id already but no token (user was linked at one point and then removed)</span></div><div class="line">                <span class="keyword">if</span> (!user.google.token) &#123;</div><div class="line">                    user.google.token = token;</div><div class="line">                    user.google.name  = profile.displayName;</div><div class="line">                    user.google.email = profile.emails[<span class="number">0</span>].value; <span class="comment">// pull the first email</span></div><div class="line">                    user.google.imageUrl = profile.photos[<span class="number">0</span>].value; <span class="comment">// pull the first image</span></div><div class="line"></div><div class="line">                    initUserFolderStructure(profile.id, () =&gt; &#123;</div><div class="line">                        user.save(<span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</div><div class="line">                            <span class="keyword">if</span> (err) &#123;</div><div class="line">                                <span class="keyword">throw</span> err;</div><div class="line">                            &#125;</div><div class="line">                            <span class="keyword">return</span> done(<span class="literal">null</span>, user);</div><div class="line">                        &#125;);</div><div class="line">                    &#125;);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="keyword">if</span>(!user.mustacceptterms) &#123;</div><div class="line">                    initUserFolderStructure(profile.id, () =&gt; &#123;</div><div class="line">                        user.save(<span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</div><div class="line">                            <span class="keyword">if</span> (err) &#123;</div><div class="line">                                <span class="keyword">throw</span> err;</div><div class="line">                            &#125;</div><div class="line">                            <span class="keyword">return</span> done(<span class="literal">null</span>, user);</div><div class="line">                        &#125;);</div><div class="line">                    &#125;);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="keyword">return</span> done(<span class="literal">null</span>, user);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// brand new user</span></div><div class="line">            <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">var</span> newUser = <span class="keyword">new</span> User();</div><div class="line"></div><div class="line">                newUser.google.id       = profile.id;</div><div class="line">                newUser.google.token    = token;</div><div class="line">                newUser.google.name     = profile.displayName;</div><div class="line">                newUser.google.email    = profile.emails[<span class="number">0</span>].value; <span class="comment">// pull the first email</span></div><div class="line">                newUser.google.imageUrl = profile.photos[<span class="number">0</span>].value; <span class="comment">// pull the first image</span></div><div class="line">                newUser.mustacceptterms = <span class="literal">true</span>;     <span class="comment">// the new user must accept terms of use before creating the account on MyPortfolio</span></div><div class="line">                </div><div class="line">                newUser.save(<span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</div><div class="line">                    <span class="keyword">if</span> (err) &#123;</div><div class="line">                        <span class="keyword">throw</span> err;</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">return</span> done(<span class="literal">null</span>, newUser);</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// user already exists and is logged in, we have to link accounts</span></div><div class="line">        <span class="keyword">var</span> user = req.user; <span class="comment">// pull the user out of the session</span></div><div class="line"></div><div class="line">        user.google.id       = profile.id;</div><div class="line">        user.google.token    = token;</div><div class="line">        user.google.name     = profile.displayName;</div><div class="line">        user.google.email    = profile.emails[<span class="number">0</span>].value; <span class="comment">// pull the first email</span></div><div class="line">        user.google.imageUrl = profile.photos[<span class="number">0</span>].value; <span class="comment">// pull the first image</span></div><div class="line"></div><div class="line">        initUserFolderStructure(profile.id, () =&gt; &#123;</div><div class="line">            user.save(<span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</div><div class="line">                <span class="keyword">if</span> (err) &#123;</div><div class="line">                    <span class="keyword">throw</span> err;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">return</span> done(<span class="literal">null</span>, user);</div><div class="line">            &#125;);</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;));</div></pre></td></tr></table></figure>
<p>If a user logs in to MyPortfolio for the first time (<em>‘A brand new user’</em>), he will be saved to the database with the flag <em>mustacceptterms</em> set to <em>true</em>, and no folder structure will be created.</p>
<p>Even if the user had previously logged in without accepting the Terms of Use, he would just be considered authenticated, but the flag <em>mustacceptterms</em> would remain set to <em>true</em>.</p>
<p>So I added two different functions to determine if user is really logged-in, or if he’s just authenticated, and the flag <em>mustacceptterms</em> is the determiner.</p>
<h2 id="Handling-routing"><a href="#Handling-routing" class="headerlink" title="Handling routing"></a>Handling routing</h2><p>The <em><a href="https://github.com/evildead/my-portfolio/blob/master/app/routes.js" target="_blank" rel="external">routes.js</a></em> contains the authentication logic (and much more):</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// routes.js</span></div><div class="line"></div><div class="line"><span class="comment">// create a new express Router</span></div><div class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>),</div><div class="line">    router = express.Router(),</div><div class="line">    multer = <span class="built_in">require</span>(<span class="string">'multer'</span>),</div><div class="line">    multerupload = multer(&#123;</div><div class="line">        dest: <span class="string">'uploads/'</span>,</div><div class="line">        limits: &#123; <span class="attr">fieldSize</span>: <span class="number">25</span> * <span class="number">1024</span> * <span class="number">1024</span> &#125;</div><div class="line">    &#125;),</div><div class="line">    mainController = <span class="built_in">require</span>(<span class="string">'./controllers/main.controller'</span>),</div><div class="line">    authController = <span class="built_in">require</span>(<span class="string">'./controllers/auth.controller'</span>),</div><div class="line">    portfoliosController = <span class="built_in">require</span>(<span class="string">'./controllers/portfolios.controller'</span>);</div><div class="line"></div><div class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</div><div class="line"></div><div class="line"><span class="comment">// route middleware to make sure a user is logged in</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">isLoggedIn</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">    <span class="comment">// if user is authenticated in the session and the terms of use have been accepted, pass the control to the "next()" handler</span></div><div class="line">    <span class="keyword">if</span> (req.isAuthenticated() &amp;&amp; !req.user.mustacceptterms) &#123;</div><div class="line">        <span class="keyword">return</span> next();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// otherwise redirect him to the home page</span></div><div class="line">    res.redirect(<span class="string">'/'</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// route middleware to make sure a user is temporarily logged in to accept terms of use</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">isLoggedInToAcceptTerms</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">    <span class="comment">//console.log(req.user);</span></div><div class="line">    <span class="comment">// if user is authenticated in the session and the terms of use have not been accepted, pass the control to the "next()" handler</span></div><div class="line">    <span class="keyword">if</span> (req.isAuthenticated() &amp;&amp; req.user.mustacceptterms) &#123;</div><div class="line">        <span class="keyword">return</span> next();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// otherwise redirect him to the home page</span></div><div class="line">    res.redirect(<span class="string">'/'</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// export router</span></div><div class="line"><span class="built_in">module</span>.exports = router;</div><div class="line"></div><div class="line"><span class="comment">// define routes</span></div><div class="line"><span class="comment">// main routes</span></div><div class="line">router.get(<span class="string">'/'</span>, mainController.showHome);</div><div class="line"></div><div class="line"><span class="comment">// route for showing the "Terms of Use" page</span></div><div class="line">router.get(<span class="string">'/termsofuse'</span>, mainController.showTermsOfUse);</div><div class="line"></div><div class="line"><span class="comment">// Google OAuth authentication</span></div><div class="line">router.get(<span class="string">'/auth/google'</span>, passport.authenticate(<span class="string">'google'</span>, &#123; <span class="attr">scope</span> : [<span class="string">'profile'</span>, <span class="string">'email'</span>] &#125;));</div><div class="line"></div><div class="line"><span class="comment">// the callback after Google has authenticated the user</span></div><div class="line">router.get(<span class="string">'/auth/google/callback'</span>,</div><div class="line">    passport.authenticate(<span class="string">'google'</span>, &#123;<span class="attr">failureRedirect</span> : <span class="string">'/'</span>&#125;),    <span class="comment">// on failure Google authentication</span></div><div class="line">    <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;        <span class="comment">// on correct Google authentication</span></div><div class="line">        <span class="comment">// User must accept the terms of use before creating the account</span></div><div class="line">        <span class="keyword">if</span>(req.user.mustacceptterms) &#123;</div><div class="line">            fs.readFile(<span class="string">'./public/assets/termsOfUse.html'</span>, (err, data) =&gt; &#123;</div><div class="line">                <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</div><div class="line">                res.render(<span class="string">'pages/acceptTermsOfUse'</span>, &#123;</div><div class="line">                    user : req.user,</div><div class="line">                    termscontent: data</div><div class="line">                &#125;);</div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// User has already accepted the terms of use</span></div><div class="line">        <span class="keyword">else</span> &#123;</div><div class="line">            res.redirect(<span class="string">'/portfolios/editPortfolioInfos'</span>);</div><div class="line">        &#125;</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">// route for showing the profile page</span></div><div class="line">router.get(<span class="string">'/account'</span>, isLoggedIn, authController.showAccount);</div><div class="line"></div><div class="line"><span class="comment">// route for handling the terms of use acceptance</span></div><div class="line">router.post(<span class="string">'/accepttermsofuse'</span>, isLoggedInToAcceptTerms, authController.processAcceptTermsOfUse);</div><div class="line">...</div></pre></td></tr></table></figure>
<p>The utility function <em>isLoggedIn</em> determines if a user is logged in the application.</p>
<p>The utility function <em>isLoggedInToAcceptTerms</em> determines if a user is just authenticated (but still never accepted the Terms of Use).</p>
<p>The route ‘/auth/google’ uses passport authentication method (which was previously configured with the Google Oauth2 Strategy) to authenticate the user with his Google account.</p>
<p>The magic happens for the route ‘/auth/google/callback’, which represents the callback invoked after the Google authentication procedure. I used a ‘failureRedirect’ to the home page when the authentication fails, and a <em>Custom function</em> on correct Google authentication.</p>
<p>Thanks to this custom function I can determine whether the Terms of Use haven’t been previously accepted, and in that case redirect the user to the Terms of Use page: from there the user will have the chance to read and accept the Terms and complete the sign-in process.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/11/08/Node-js-Passport-and-Terms-of-Use-sign-in-to-MyPortfolio/" data-id="cj9yggl3b0001twne8oktgwrd" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2017/11/06/CMemento11/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">CMemento11</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/11/08/Node-js-Passport-and-Terms-of-Use-sign-in-to-MyPortfolio/">Node.js Passport and Terms of Use: sign in to MyPortfolio</a>
          </li>
        
          <li>
            <a href="/2017/11/06/CMemento11/">CMemento11</a>
          </li>
        
          <li>
            <a href="/2017/11/05/DanJsonp-Class/">DanJsonp Class</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 Danilo Carrabino<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>